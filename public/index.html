<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <script src="/all.js"></script>
  <link rel="stylesheet" href="styles.css">

  <title>Timetable App</title>
</head>

<body>

  <div class="container mt-5">
  <h1 class="text-center mb-4">TIME TABLE - Jul-Dec 2023</h1>
   
  <!-- Batch Selection Dropdown -->
<div class="mb-4">
  <label for="batchSelect" class="form-label">Select Batch:</label>
  <select class="form-control" id="batchSelect">
    <option>Bachelor of Design UX V</option>
    <option>Bachelor of Design UX VII</option>
    <!-- Add more batches as needed -->
  </select>
</div>


<!-- Week Tabs -->
<div class="nav-container">
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link active" href="#week1" data-toggle="tab">Week 1</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#week2" data-toggle="tab">Week 2</a>
    </li>
  </ul>
  <div class="button-container">
    <button id="removeAllButton" class="btn custom-button remove-button">Remove All</button>
    <button id="saveButton" class="btn custom-button save-button">Save</button>
  </div>
</div>


  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Week 1 Tab -->
    <div class="tab-pane active" id="week1">
      <h3 class="mt-3">Week 1: Oct 02, 2023 - Oct 06, 2023</h3>
      <!-- Week 1 Table Here -->
      <!-- Implement Week 1 Table -->
    </div>
    <!-- End Week 1 Tab -->
    <!-- Week 2 Tab -->
    <div class="tab-pane" id="week2">
      <h3 class="mt-3">Week 2: Oct 09, 2023 - Oct 13, 2023</h3>
      <!-- Week 2 Table Here -->
      <!-- Implement Week 2 Table -->
    </div>
    <!-- End Week 2 Tab -->
    <!-- Add similar blocks for other weeks -->
  </div>
  
</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>



    <table class="table table-bordered">
<!--       <button id="saveButton" class="btn btn-primary">Save</button>
      <button onclick="removeAllSubjects()">Remove All</button>
 -->

      <thead>
        <tr>
          <th scope="col">Day/Time</th>
          <th scope="col">9:45-10:35</th>
          <th scope="col">10:35-11:25</th>
          <th scope="col">11:25-12:15</th>
          <th scope="col">12:15-1:05</th>
          <th scope="col"></th>
          <th scope="col">1:35-2:25</th>
          <th scope="col">2:25-3:15</th>
        </tr>
        
      </thead>
      <tbody>
        <!-- Repeat this block for each day -->
        <tr>
          


          <th scope="row">Monday</th>
          <!-- Repeat this block for each time slot -->
          
          <td class="editable-cell" style="position:relative;" id="Monday-9:45-10:35">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          

        
          
        <td class="editable-cell" style="position:relative;" id="Monday-10:35-11:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>


        <td class="editable-cell" style="position:relative;" id="Monday-11:25-12:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          


        <td class="editable-cell" style="position:relative;" id="Monday-12:15-1:05">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          <!-- End time slot block -->
          <!-- Insert Break Cell for Monday Only -->
          <td rowspan="5" class="text-center text-secondary align-middle" style="writing-mode: vertical-rl; transform: rotate(180deg);">Break</td>
          <td class="editable-cell" style="position:relative;" id="Monday-1:35-2:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Monday-2:25-3:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        </tr>
        <tr>
          <th scope="row">Tuesday</th>
          <!-- Repeat this block for each time slot -->
          <td class="editable-cell" style="position:relative;" id="Tuesday-9:45-10:35">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Tuesday-10:35-11:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Tuesday-11:25-12:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Tuesday-12:15-1:05">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          <!-- End time slot block -->
          <!-- Insert Break Cell for Monday Only -->
          
          <td class="editable-cell" style="position:relative;" id="Tuesday-1:35-2:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Tuesday-2:25-3:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

        </tr>

        <tr>
          <th scope="row">Wednesday</th>
          <!-- Repeat this block for each time slot -->
          <td class="editable-cell" style="position:relative;" id="Wednesday-9:45-10:35">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Wednesday-10:35-11:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Wednesday-11:25-12:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Wednesday-12:15-1:05">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          <!-- End time slot block -->
          <!-- Insert Break Cell for Monday Only -->
          
          <td class="editable-cell" style="position:relative;" id="Wednesday-1:35-2:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Wednesday-2:25-3:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        </tr>

        <tr>
          <th scope="row">Thursday</th>
          <!-- Repeat this block for each time slot -->
          <td class="editable-cell" style="position:relative;" id="Thursday-9:45-10:35">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Thursday-10:35-11:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Thursday-11:25-12:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Thursday-12:15-1:05">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          <!-- End time slot block -->
          <!-- Insert Break Cell for Monday Only -->
          
          <td class="editable-cell" style="position:relative;" id="Thursday-1:35-2:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Thursday-2:25-3:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        </tr>

        <tr>
          <th scope="row">Friday</th>
          <!-- Repeat this block for each time slot -->
          <td class="editable-cell" style="position:relative;" id="Friday-9:45-10:35">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Friday-10:35-11:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Friday-11:25-12:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Friday-12:15-1:05">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
          <!-- End time slot block -->
          <!-- Insert Break Cell for Monday Only -->
          
          <td class="editable-cell" style="position:relative;" id="Friday-1:35-2:25">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        <td class="editable-cell" style="position:relative;" id="Friday-2:25-3:15">
            <select class="custom-select subject-select" onchange="setSubject(this)">
                <option value="" disabled selected>Subject</option>
            </select>
            <i class="fa-solid fa-pen-to-square edit-icon hidden"></i>
        </td>

          
        </tr>

        <!-- End day block -->
        <!-- Add similar blocks for Tuesday to Friday -->
      </tbody>
    </table>
  </div>

 <script>
let subjectData = {}; // This will hold the fetched subject data

window.onload = function () {
  // Fetch subject data from the server
  fetch('http://localhost:3000/api/subjects')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      // Store fetched data in subjectData variable
      subjectData = data;
      // Populate select elements
      const selects = document.querySelectorAll('.subject-select');
      for (const select of selects) {
        for (const subject in data) {
          const option = document.createElement('option');
          option.text = subject;
          option.value = subject;
          select.add(option);
        }
      }
      
      // After subjects have been loaded, load the timetable data
      // Get the initial values for week and batch and pass to loadTimetableData function
      const initialWeek = document.querySelector('.nav-link.active').innerText; // adjust if necessary
      const initialBatch = document.getElementById('batchSelect').value; // adjust if necessary
      loadTimetableData(initialWeek, initialBatch); // calling the function to load timetable data
    })
    .catch(error => {
      console.error('Error fetching the subjects:', error);
    });

  // Listen for changes on the batch select dropdown
  document.getElementById('batchSelect').addEventListener('change', function() {
    // Fetch timetable data from the server for the selected week and batch
    const selectedWeek = document.querySelector('.nav-link.active').innerText;
    const selectedBatch = this.value;
    
    loadTimetableData(selectedWeek, selectedBatch); // replaced previous fetch with function call
  });
};


function populateTimetable(data) {
  if (!data || !data.days) return;

  data.days.forEach(dayData => {
    if (!dayData.day || !dayData.slots) return;

    dayData.slots.forEach(slot => {
      // Validate slot data
      if (!slot.time || typeof slot.time !== 'string') {
        console.error('Invalid slot data (time):', slot);
        return; // Skip this slot if time is not defined or not a string
      }

      // Handle empty subject
      if (!slot.subject || slot.subject.trim() === '') {
        console.warn('Empty subject:', slot);
        // If the subject is empty, you might not want to proceed further
        return;
      }

      const cellId = `${dayData.day}-${slot.time}`;
      const cell = document.getElementById(cellId);
      if (cell) {
        const select = cell.querySelector('select');
        if (select) {
          select.value = slot.subject; // Assign value only if subject is not empty

          // hide the select box and display the subject and faculty in the required format
          select.style.display = 'none';
          const displayDiv = document.createElement('div');
          displayDiv.innerHTML = '<strong>' + slot.faculty + '</strong><br>' + slot.subject;
          cell.appendChild(displayDiv);
          cell.classList.add('subject-selected');

          // If there is an edit icon, display it
          const editIcon = cell.querySelector('.edit-icon');
          if(editIcon){
            editIcon.classList.remove('hidden');
          }
        }
      } else {
        console.error('Cell not found:', cellId);
      }
    });
  });
}












document.getElementById('saveButton').addEventListener('click', function() {
    const compiledData = compileTimetableData();
    saveTimetableData(compiledData);
});



function compileTimetableData() {
    const data = {
        week: document.querySelector('.nav-link.active').innerText,
        batch: document.getElementById('batchSelect').value,
        days: []
    };
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    days.forEach(day => {
        const dayData = { day: day, slots: [] };
        const timeSlots = document.querySelectorAll(`td[id^=${day}-] .subject-select`);
        timeSlots.forEach(slot => {
          const time = slot.closest('td').id.split('-')[1] + '-' + slot.closest('td').id.split('-')[2];
          const subjectName = slot.value;

          // Handling Missing Faculty Names
          if (subjectData[subjectName] === undefined) {
              console.error('Faculty name not found for subject:', subjectName);
              // You might want to return here or handle it in another way
              // return; // Uncomment if you want to skip slots with missing faculty names
          }

          dayData.slots.push({
              time: time,
              subject: subjectName,
              faculty: subjectData[subjectName] || 'Not Available' // Default to 'Not Available' if faculty not found
          });
        });
        data.days.push(dayData);
    });
    return data;
}






document.body.addEventListener('click', function(e) {
    console.log('Clicked element:', e.target);
    console.log('Closest .edit-icon:', e.target.closest('.edit-icon'));
    if(e.target.closest('.edit-icon')) {
        e.stopPropagation();
        editSubject(e.target.closest('.edit-icon'));
    }
});


function setSubject(element) {
  if (!(element instanceof HTMLElement)) element = this; // Allow for being called as an event handler
  const selectedSubject = element.value;
  element.style.display = 'none'; 
  const parentCell = element.parentNode;
  const displayDiv = document.createElement('div');
  displayDiv.innerHTML = '<strong>' + subjectData[selectedSubject] + '</strong><br>' + selectedSubject;
  parentCell.appendChild(displayDiv); 
  parentCell.classList.add('subject-selected');
  const editIcon = parentCell.querySelector('.edit-icon'); 
  editIcon.classList.remove('hidden'); 
  parentCell.classList.add('editable'); // Add this line
  // saveSubject('someCellId', selectedSubject);
}
function removeAllSubjects() {
    const confirmation = confirm('Are you sure you want to remove all data? This cannot be undone.');
    if (!confirmation) return;

    // Select all cells with the 'editable-cell' class
    const allCells = document.querySelectorAll('.editable-cell');

    // Iterate over all cells and reset them
    allCells.forEach(cell => {
        const selectElement = cell.querySelector('select');
        const displayDiv = cell.querySelector('div');
        const editIcon = cell.querySelector('.edit-icon');

        // If any element is not found, log an error and return
        if (!selectElement || !displayDiv || !editIcon) {
            console.error('Select element, display div, or edit icon not found in cell:', cell);
            return;
        }

        editIcon.classList.add('hidden'); // Hide the edit icon
        displayDiv.remove(); // Remove the displayed subject
        selectElement.style.display = 'inline-block'; // Show the select element again
        selectElement.value = ""; // Reset the value of the select to the default state
    });

    // After all cells are cleared, compile the data and save it
    const compiledData = compileTimetableData();
    saveTimetableData(compiledData);
}


function editSubject(element) {
  const parentCell = element.parentNode;
  const selectElement = parentCell.querySelector('select');
  const displayDiv = parentCell.querySelector('div');

  // First, check if the elements are selected correctly
  if (!selectElement || !displayDiv) {
    console.error('Select element or display div not found in cell:', parentCell);
    return;
  }

  element.classList.add('hidden'); // Hide the edit icon
  displayDiv.remove(); // Remove the displayed subject
  selectElement.style.display = 'inline-block'; // Show the select element again
  selectElement.value = ""; // Reset the value of the select to the default state
}

/* function saveSubject(cellID, selectedSubject) {
  fetch('http://localhost:3000/update-slot', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      week: 'your_week',
      batch: 'your_batch',
      day: 'your_day',
      time: 'your_time',
      subject: selectedSubject,
      faculty: 'your_faculty', // You need to provide the faculty as well
    }),
  })
  .then(response => response.json())
  .then(data => console.log(data))
  .catch((error) => console.error('Error:', error));
} */


function saveTimetableData(data) {
    fetch('http://localhost:3000/api/timetable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        // Handle success
        // Update UI to reflect that data was saved successfully
    })
    .catch((error) => {
        console.error('Error:', error);
        // Handle error
        // Show error message to the user
    });
}
// Paste this function after your existing functions
function loadTimetableData(week, batch) {
  // Adding a loading indicator or some UI feedback here would be a good practice
  // For instance, you could use a spinner or change the cursor to 'wait'

  // Fetch timetable data based on the selected week and batch
  fetch(`http://localhost:3000/api/timetable?week=${week}&batch=${batch}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      return response.json(); // parse the JSON from the response
    })
    .then(data => {
      // Assuming the server returns an object where `data` is null or empty if there's no record
      if (!data || Object.keys(data).length === 0) {
        // Handle non-existing data here
        console.log('No data found for selected week and batch');
        // You might want to reset the timetable to default/empty state here
      } else {
        // Call the function here with fetched data to populate the timetable
        populateTimetable(data); // replace with your actual function for populating the timetable
      }
    })
    .catch(error => {
      console.error('Error fetching the timetable:', error);
      // You might want to handle UI feedback for failed request here
    })
    .finally(() => {
      // Remove loading indicator or reset UI feedback here
      // For instance, reset the cursor to 'default' or hide the spinner
    });
}
document.getElementById('removeAllButton').addEventListener('click', removeAllSubjects);


</script>




</body>

</html>
